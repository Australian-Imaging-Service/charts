apiVersion: v1
kind: Pod
metadata:
  name: {{ template "postgresql.master.fullname" . }}-test-connection
  annotations:
    "helm.sh/hook": test
spec:
  containers:
  - image: ubuntu
    env:
      - name: POSTGRESQL_PORT_NUMBER
        value: "{{ template "postgresql.port" . }}"
      - name: POSTGRESQL_SERVICE_NAME
        value: "{{ template "postgresql.fullname" . }}"
      - name: POSTGRES_POSTGRES_PASSWORD
        valueFrom:
          secretKeyRef:
            name: {{ template "postgresql.secretName" . }}
            key: postgresql-password
      - name: POSTGRES_USER
        value: {{ include "postgresql.username" . | quote }}
      - name: POSTGRES_DB
        value: {{ (include "postgresql.database" .) | quote }}
    command: ["/bin/sh"]
    args: ["-c","apt-get update -y && apt-get install postgresql-client -y && echo 'psql postgresql://$(POSTGRES_USER):$(POSTGRES_POSTGRES_PASSWORD)@$(POSTGRESQL_SERVICE_NAME):$(POSTGRESQL_PORT_NUMBER)/$(POSTGRES_DB)' && psql postgresql://$(POSTGRES_USER):$(POSTGRES_POSTGRES_PASSWORD)@$(POSTGRESQL_SERVICE_NAME):$(POSTGRESQL_PORT_NUMBER)/$(POSTGRES_DB)"]
    imagePullPolicy: IfNotPresent
    name: ubuntu
  restartPolicy: Never
---
