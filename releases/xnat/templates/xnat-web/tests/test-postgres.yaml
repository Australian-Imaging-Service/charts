apiVersion: v1
kind: Pod
metadata:
  name: {{ template "xnat-web.fullname" . }}-test-database
  labels:
    {{- include "xnat-web.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
{{- with (index .Values "xnat-web") }}
  securityContext:
    {{- toYaml .podSecurityContext | nindent 4 }}
  containers:
    - name: postgres
      securityContext:
        {{- toYaml .securityContext | nindent 8 }}
{{- end }}
      image: postgres
      command: [pg_isready]
      env:
        - name: PGDATABASE
          {{- (include "xnat.postgresql.database" .) | nindent 10 }}
        - name: PGHOST
          {{- (include "xnat.postgresql.host" .) | nindent 10 }}
        - name: PGPASSWORD
          {{- (include "xnat.postgresql.password" .) | nindent 10 }}
        - name: PGPORT
          {{- (include "xnat.postgresql.port" .) | nindent 10 }}
        - name: PGUSER
          {{- (include "xnat.postgresql.user" .) | nindent 10 }}
      imagePullPolicy: IfNotPresent
  restartPolicy: Never
