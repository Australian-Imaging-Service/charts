suite: test postgresql existing secret
templates:
  - xnat-web/configmap.yaml
  - xnat-web/secret.yaml
  - xnat-web/statefulset.yaml
tests:
  - asserts:
      - isKind:
          of: StatefulSet
      - matchRegex:
          path: metadata.name
          pattern: -xnat-web$
      - equal:
          path: spec.template.spec.initContainers[0].env[0].valueFrom.secretKeyRef.name
          value: existing-secret
      - equal:
          path: spec.template.spec.initContainers[0].env[0].valueFrom.secretKeyRef.key
          value: dbname
      - equal:
          path: spec.template.spec.initContainers[0].env[1].valueFrom.secretKeyRef.name
          value: existing-secret
      - equal:
          path: spec.template.spec.initContainers[0].env[1].valueFrom.secretKeyRef.key
          value: host
      - equal:
          path: spec.template.spec.initContainers[0].env[2].valueFrom.secretKeyRef.name
          value: existing-secret
      - equal:
          path: spec.template.spec.initContainers[0].env[2].valueFrom.secretKeyRef.key
          value: password
      - equal:
          path: spec.template.spec.initContainers[0].env[3].valueFrom.secretKeyRef.name
          value: existing-secret
      - equal:
          path: spec.template.spec.initContainers[0].env[3].valueFrom.secretKeyRef.key
          value: "5432"
      - equal:
          path: spec.template.spec.initContainers[0].env[4].valueFrom.secretKeyRef.name
          value: existing-secret
      - equal:
          path: spec.template.spec.initContainers[0].env[4].valueFrom.secretKeyRef.key
          value: username
    it: should use existing secret
    set:
      postgresql.enabled: false
      postgresql.auth.existingSecret: existing-secret
      postgresql.auth.secretKeys.databaseKey: dbname
      postgresql.auth.secretKeys.hostKey: host
      postgresql.auth.secretKeys.userPasswordKey: password
      postgresql.auth.secretKeys.portKey: 5432
      postgresql.auth.secretKeys.usernameKey: username
    template: xnat-web/statefulset.yaml
  - asserts:
      - isKind:
          of: StatefulSet
      - matchRegex:
          path: metadata.name
          pattern: -xnat-web$
      - equal:
          path: spec.template.spec.initContainers[0].env[2].valueFrom.secretKeyRef.name
          value: RELEASE-NAME-postgresql
      - equal:
          path: spec.template.spec.initContainers[0].env[2].valueFrom.secretKeyRef.key
          value: password
    it: should reference sub-chart secret for password
    set:
      postgresql.enabled: true
    template: xnat-web/statefulset.yaml
